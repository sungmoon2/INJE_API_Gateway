================================================================================
외부 네트워크 환경 설정 가이드 - KULS 시스템과 실제 연동을 위해
================================================================================

현재 상태: localhost 기반 (로컬 개발 환경)
목표: 외부 LAN에서 KULS 시스템이 접근 가능한 환경

================================================================================
1. 현재 설정 분석
================================================================================

현재 로컬 전용 설정:
❌ REDIS_HOST=localhost          # 같은 컴퓨터에서만 접근
❌ 서버 바인딩: localhost:3001   # 외부에서 접근 불가
❌ Fabric CA: localhost:7054     # 로컬 Fabric 네트워크만

이미 외부 준비된 설정:
✅ ALLOWED_ORIGINS=https://api.kuls.ac.kr  # KULS 허용됨
✅ API_KEYS=kuls-api-key-2025              # KULS 전용 키 있음
✅ Docker 네트워크 구성                     # 서비스 간 통신 준비됨
✅ CORS 설정                               # 외부 도메인 요청 허용

================================================================================
2. 외부 네트워크 접근을 위한 변경사항
================================================================================

2.1 IP 바인딩 변경:
현재: localhost:3001 (127.0.0.1)
변경: 0.0.0.0:3001 (모든 네트워크 인터페이스)

파일: src/index.ts
수정 방법:
```typescript
server.listen(PORT, '0.0.0.0', () => {  // 이 부분 추가
  logger.info(`🚀 INJE API Gateway running on port ${PORT}`);
});
```

2.2 환경 변수 수정:
.env 파일에서:
```
# 현재
REDIS_HOST=localhost
FABRIC_CA_URL=http://localhost:7054

# 외부 환경용으로 변경
REDIS_HOST=10.0.1.100        # Redis 서버의 실제 IP
FABRIC_CA_URL=http://10.0.1.101:7054  # Fabric CA 서버 IP
```

2.3 방화벽 설정:
```bash
# Ubuntu/Linux에서
sudo ufw allow 3001          # API Gateway 포트 열기
sudo ufw allow 6379          # Redis 포트 (필요시)
sudo ufw allow 7054          # Fabric CA 포트 (필요시)
```

================================================================================
3. 실제 네트워크 환경별 설정
================================================================================

3.1 같은 사무실/연구실 LAN 환경:
- API Gateway 서버 IP: 192.168.1.100 (예시)
- KULS 시스템에서 접근: http://192.168.1.100:3001
- DNS 설정 불필요

필요한 변경사항:
```env
# .env
ALLOWED_ORIGINS=http://192.168.1.0/24,https://api.kuls.ac.kr
```

3.2 다른 건물/캠퍼스 환경:
- 공인 IP 또는 VPN 필요
- DNS 설정 권장: api-gateway.inje.ac.kr
- SSL/TLS 인증서 필요

필요한 변경사항:
```env
# .env
ALLOWED_ORIGINS=https://kuls.inje.ac.kr,https://api.kuls.ac.kr
```

3.3 인터넷을 통한 접근:
- 공인 IP + 포트 포워딩
- 도메인 + SSL 인증서 필수
- 보안 강화 필요

================================================================================
4. Docker 환경에서 외부 접근 설정
================================================================================

4.1 docker-compose.yml 수정:
```yaml
api-gateway:
  ports:
    - "0.0.0.0:3000:3000"    # 모든 인터페이스에서 접근 허용
  environment:
    - REDIS_HOST=redis       # 컨테이너 내부에서는 서비스명 사용
    - EXTERNAL_HOST=10.0.1.100  # 외부에서 접근할 IP
```

4.2 네트워크 브리지 설정:
```yaml
networks:
  inje-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
```

================================================================================
5. KULS 시스템에서 접근하는 방법
================================================================================

5.1 KULS 시스템에서 API 호출 예시:
```javascript
// KULS 시스템 코드
const API_GATEWAY_URL = 'http://10.0.1.100:3001';  // 실제 서버 IP
const API_KEY = 'kuls-api-key-2025';

fetch(`${API_GATEWAY_URL}/api/v1/transactions/submit`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': API_KEY
  },
  body: JSON.stringify({
    correlationId: 'kuls-' + Date.now(),
    containerId: container_id,
    instruction: 'LOAD_CARGO',
    source: 'KULS_SYSTEM',
    callbackUrl: 'http://kuls-server.inje.ac.kr/webhook'
  })
});
```

5.2 웹훅 수신 설정:
KULS 시스템에서 웹훅을 받으려면:
```javascript
// KULS 서버에 웹훅 엔드포인트 구현
app.post('/webhook', (req, res) => {
  const signature = req.headers['x-inje-signature'];
  // HMAC 검증 로직

  console.log('블록체인 트랜잭션 완료:', req.body);
  res.status(200).json({ received: true });
});
```

================================================================================
6. 네트워크 테스트 방법
================================================================================

6.1 로컬 네트워크에서 테스트:
```bash
# 다른 컴퓨터에서
curl http://192.168.1.100:3001/health

# 응답이 나오면 성공
{"status":"healthy",...}
```

6.2 방화벽 확인:
```bash
# 서버에서
netstat -tlnp | grep 3001  # 포트가 열려있는지 확인
ss -tlnp | grep 3001       # 또는 이 명령어

# 결과 예시
tcp6  0  0 :::3001  :::*  LISTEN  12345/node
```

6.3 연결 테스트:
```bash
# KULS 시스템에서
telnet 10.0.1.100 3001    # 포트 연결 테스트
```

================================================================================
7. 보안 고려사항
================================================================================

7.1 외부 접근 시 보안 강화:
- API 키 주기적 교체
- IP 화이트리스트 추가
- Rate Limiting 강화
- SSL/TLS 암호화

7.2 환경 변수 추가:
```env
# .env
ALLOWED_IPS=192.168.1.0/24,10.0.1.0/24  # 허용 IP 대역
MAX_REQUESTS_PER_MINUTE=50               # 더 엄격한 제한
```

7.3 미들웨어 추가:
```typescript
// IP 화이트리스트 미들웨어
app.use((req, res, next) => {
  const clientIP = req.ip;
  const allowedIPs = process.env.ALLOWED_IPS?.split(',') || [];

  if (!isIPAllowed(clientIP, allowedIPs)) {
    return res.status(403).json({ error: 'IP not allowed' });
  }
  next();
});
```

================================================================================
8. 단계별 외부 환경 적용 가이드
================================================================================

8.1 1단계: 같은 네트워크 테스트
1. 서버 IP 바인딩을 0.0.0.0으로 변경
2. 방화벽에서 3001 포트 열기
3. 같은 네트워크의 다른 컴퓨터에서 테스트

8.2 2단계: KULS 시스템과 연동
1. KULS 시스템에 API Gateway IP 설정
2. API 키 공유
3. 웹훅 URL 설정

8.3 3단계: 실제 Fabric 네트워크 연결
1. Mock 모드에서 실제 Fabric으로 전환
2. Connection Profile 업데이트
3. 인증서 및 지갑 설정

================================================================================
9. 현재 구현의 외부 환경 준비도
================================================================================

✅ 이미 준비된 것들:
- API 키 인증 시스템
- CORS 설정 (외부 도메인 허용)
- 구조화된 에러 처리
- Rate Limiting
- 웹훅 시스템
- Docker 컨테이너화

🔄 변경 필요한 것들:
- IP 바인딩 (localhost → 0.0.0.0)
- 환경 변수 (localhost → 실제 IP)
- 방화벽 설정

⚠️ 추가 고려사항:
- SSL/TLS 인증서 (HTTPS)
- 로드 밸런싱 (고가용성)
- 모니터링 시스템

================================================================================
10. 즉시 적용 가능한 외부 접근 설정
================================================================================

지금 당장 외부에서 접근하게 하려면:

1. 서버 재시작 시 바인딩 변경:
```bash
cd /home/minsujo/inje-api-gateway
PORT=3001 HOST=0.0.0.0 npm run dev
```

2. 방화벽 열기:
```bash
sudo ufw allow 3001
```

3. 서버 IP 확인:
```bash
ip addr show | grep inet
```

4. 다른 컴퓨터에서 테스트:
```bash
curl http://[서버IP]:3001/health
```

================================================================================
결론: 외부 환경 준비도 90%
================================================================================

현재 구현은 외부 환경 연동을 위한 대부분의 준비가 완료되어 있습니다.
단순히 localhost → 실제 IP 변경만으로도 외부 접근이 가능합니다.

KULS 시스템과의 실제 연동은:
1. 네트워크 설정 (IP, 포트, 방화벽)
2. API 키 공유
3. 웹훅 URL 설정

이 3가지만 하면 즉시 가능합니다! 🚀
================================================================================